<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.payment">
	<!-- <insert id="insertPayment" parameterType="paymentVo">
	<selectKey keyProperty="paymentCode" order="BEFORE" resultType="int">
		select payment_seq.nextval from dual
	</selectKey>
	insert into payment
	values(#{paymentCode},'카드','결제완료',0,sysdate,sysdate+100,#{serviceCode},#{memberCode},#{jobopening})
	</insert> -->
	
	<insert id="insertPayment" parameterType="paymentVo">
	<selectKey keyProperty="paymentCode" order="BEFORE" resultType="int">
		select payment_seq.nextval from dual
	</selectKey>
	insert into payment
	values(#{paymentCode},'카드','결제완료',0,sysdate,sysdate+100,#{serviceCode},#{memberCode},#{jobopening})
	</insert>
	
	<select id="getpaymentJobCount" resultType="int" parameterType="int">
	select count(*) from payment where jobopening=#{jobopening}
	</select>
	
	<update id="cancelPay" parameterType="int">
	update payment
	set progress='결제취소요청'
	where payment_code=#{paymentCode}
	</update>
	
	<select id="selectPaymentById" parameterType="string" resultType="map">
		select p.*, s.* 
		from payment p join service s
		on p.SERVICE_CODE = s.SERVICE_CODE
		where member_code=(select member_code from member where memberid=#{memberid})
	</select>
	
	<select id="selectPaymentByCode" parameterType="int" resultType="paymentVo">
		select * from payment
		where payment_code=#{paymentCode}
	</select>
	
	<select id="selectMainAdvertiseByServiceCode" resultType="map" parameterType="int">
	select v.*, c.*, trunc(end_date-sysdate) as dday
	from vvipmain v join companyJobOpen c
	on c.COMPANY_CODE = v.COMPANY_CODE
	where service_code=#{serviceCode}
	</select>
	
	<select id="getCountByJobopening" resultType="int" parameterType="int">
	select count(*) from payment where jobopening=#{jobopening} and progress='결제완료'
	</select>
	
	<update id="updatePaysuccess" parameterType="int">
	update payment
	set progress='결제완료'
	where payment_code=#{paymentCode}
	</update>


	 <select id="selectTotalCount" parameterType="searchVo" resultType="int">
	 select count(*) from payment a join service b
				on a.service_code = b.service_code
				join member c
				on a.member_code = c.member_code
	 
	
	 <if test="searchKeyword != null and searchKeyword !=''">
	 	where ${searchCondition} like '%' || #{searchKeyword} || '%'
	 </if>
	 </select>


	<select id="selectPayment" parameterType="map" resultType="map" >
	select* from
	(
		select A.*, rownum as RNUM from 
		(
			select payment_code,paymentway,progress,discount,paydate, s.servicename, m.memberid
				from payment p join service s
				on p.service_code = s.service_code
				join member m
				on p.member_code = m.member_code
				<where>
							<if test="searchVo.searchCondition!= null and searchVo.searchCondition!=''
								and searchVo.searchKeyword!= null and searchVo.searchKeyword!=''">
							
							<if test='searchVo.searchCondition=="all"'>
									progress like  '%' || #{searchVo.searchKeyword}  || '%' or
									m.memberid like  '%' || #{searchVo.searchKeyword} || '%' 
							</if>
							<if test='searchVo.searchCondition=="memberid"'>
									 m.memberid like  '%' || #{searchVo.searchKeyword} || '%'
							</if>

							<if test='searchVo.searchCondition=="progress"'>
									 progress like  '%' || #{searchVo.searchKeyword} || '%'
							</if>

							
							<if test="startDay!=null and startDay !='' and endDay!=null and endDay != ''">
								 <![CDATA[ or paydate >= #{startDay} and paydate <to_date(#{endDay})+1]]>
							</if>
					</if>				
					
					<if test="searchVo.searchCondition== null or searchVo.searchCondition==''
								or searchVo.searchKeyword== null or searchVo.searchKeyword==''">
						<if test="startDay!=null and startDay !='' and endDay!=null and endDay != ''">
							 <![CDATA[paydate >= #{startDay} and paydate <to_date(#{endDay})+1]]>
						</if>	
					</if>
				</where>

			) A
		)
	<![CDATA[where RNUM>#{searchVo.firstRecordIndex}  
		and RNUM<=#{searchVo.firstRecordIndex} + #{searchVo.recordCountPerPage}]]> 
	</select>
	

	
</mapper>

